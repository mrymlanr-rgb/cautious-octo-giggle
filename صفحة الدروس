import streamlit as st
import json
from streamlit_ace import st_ace
from utils.code_executor import CodeExecutor
from utils.progress_tracker import ProgressTracker

# Page configuration
st.set_page_config(page_title="Ø§Ù„Ø¯Ø±ÙˆØ³", page_icon="ğŸ“š", layout="wide")

# Initialize utilities
@st.cache_data
def load_lessons():
    with open('lessons/lessons_data.json', 'r', encoding='utf-8') as f:
        return json.load(f)

if 'code_executor' not in st.session_state:
    st.session_state.code_executor = CodeExecutor()

if 'progress_tracker' not in st.session_state:
    st.session_state.progress_tracker = ProgressTracker()

# Load lessons data
lessons_data = load_lessons()
lessons = lessons_data['lessons']

st.title("ğŸ“š Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©")

# Sidebar for lesson navigation
st.sidebar.title("Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø±ÙˆØ³")
lesson_titles = [f"{lesson['id']}. {lesson['title']}" for lesson in lessons]
selected_lesson_index = st.sidebar.selectbox(
    "Ø§Ø®ØªØ± Ø¯Ø±Ø³:",
    range(len(lesson_titles)),
    format_func=lambda x: lesson_titles[x]
)

# Get selected lesson
selected_lesson = lessons[selected_lesson_index]
lesson_id = selected_lesson['id']

# Progress indicator
progress = st.session_state.progress_tracker.get_overall_progress()
st.sidebar.metric("Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ", f"{progress:.1f}%")

# Lesson completion status
is_completed = st.session_state.progress_tracker.is_lesson_completed(lesson_id)
if is_completed:
    st.sidebar.success("âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³")
else:
    st.sidebar.info("â³ Ù„Ù… ÙŠÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯")

# Main content
col1, col2 = st.columns([2, 1])

with col1:
    # Lesson header
    st.header(f"Ø¯Ø±Ø³ {selected_lesson['id']}: {selected_lesson['title']}")
    st.badge(selected_lesson['level'], type="secondary")
    st.write(selected_lesson['description'])
    
    # Theory section
    st.subheader("ğŸ“– Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ù†Ø¸Ø±ÙŠ")
    st.write(selected_lesson['content']['theory'])
    
    # Code example section
    st.subheader("ğŸ’» Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ")
    st.code(selected_lesson['content']['example'], language='python')
    
    # Explanation
    st.subheader("ğŸ“ Ø´Ø±Ø­ Ø§Ù„ÙƒÙˆØ¯")
    st.write(selected_lesson['content']['explanation'])
    
    # Interactive code editor
    st.subheader("ğŸ§ª Ø¬Ø±Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†ÙØ³Ùƒ")
    st.write("ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¯Ù†Ø§Ù‡ ÙˆØªØ¬Ø±Ø¨ØªÙ‡:")
    
    # Code editor
    user_code = st_ace(
        value=selected_lesson['content']['example'],
        language='python',
        theme='github',
        font_size=14,
        tab_size=4,
        wrap=True,
        height=200,
        key=f"lesson_{lesson_id}_editor"
    )
    
    # Execute button
    col_exec, col_clear = st.columns([1, 1])
    
    with col_exec:
        if st.button("â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯", type="primary"):
            if user_code.strip():
                # Validate and execute code
                is_valid, validation_msg = st.session_state.code_executor.validate_code(user_code)
                
                if is_valid:
                    with st.spinner("Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯..."):
                        result = st.session_state.code_executor.execute_code(user_code)
                        st.session_state.progress_tracker.increment_code_runs()
                    
                    if result['success']:
                        st.success("ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!")
                        if result['output']:
                            st.subheader("ğŸ“¤ Ø§Ù„Ù†ØªÙŠØ¬Ø©:")
                            st.code(result['output'], language='text')
                        st.info(f"ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ°: {result['execution_time']:.3f} Ø«Ø§Ù†ÙŠØ©")
                    else:
                        st.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯:")
                        st.code(result['error'], language='text')
                else:
                    st.error(validation_msg)
            else:
                st.warning("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø¨Ø¹Ø¶ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹")
    
    with col_clear:
        if st.button("ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯"):
            st.rerun()

with col2:
    # Quiz section
    st.subheader("ğŸ¯ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹")
    quiz = selected_lesson['quiz']
    
    st.write(quiz['question'])
    
    # Quiz options
    user_answer = st.radio(
        "Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:",
        range(len(quiz['options'])),
        format_func=lambda x: quiz['options'][x],
        key=f"quiz_{lesson_id}"
    )
    
    if st.button("ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©", key=f"check_quiz_{lesson_id}"):
        if user_answer == quiz['correct']:
            st.success("ğŸ‰ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ø£Ø­Ø³Ù†Øª!")
            st.session_state.progress_tracker.save_quiz_score(lesson_id, 1)
            if not is_completed:
                st.session_state.progress_tracker.mark_lesson_completed(lesson_id)
                st.success("ğŸ† ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³!")
                st.balloons()
                st.rerun()
        else:
            st.error("âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!")
            correct_answer = quiz['options'][quiz['correct']]
            st.info(f"Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: {correct_answer}")
    
    # Previous quiz score
    quiz_score = st.session_state.progress_tracker.get_quiz_score(lesson_id)
    if quiz_score > 0:
        st.success("âœ… Ø£Ø¬Ø¨Øª Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù…Ù† Ù‚Ø¨Ù„")
    
    # Lesson navigation
    st.subheader("ğŸ§­ Ø§Ù„ØªÙ†Ù‚Ù„")
    
    col_prev, col_next = st.columns(2)
    
    with col_prev:
        if lesson_id > 1:
            if st.button("â¬…ï¸ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø³Ø§Ø¨Ù‚"):
                st.switch_page("pages/1_Ø§Ù„Ø¯Ø±ÙˆØ³.py")
        else:
            st.write("Ù‡Ø°Ø§ Ø£ÙˆÙ„ Ø¯Ø±Ø³")
    
    with col_next:
        if lesson_id < len(lessons):
            if st.button("â¡ï¸ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„ØªØ§Ù„ÙŠ"):
                st.switch_page("pages/1_Ø§Ù„Ø¯Ø±ÙˆØ³.py")
        else:
            st.write("Ù‡Ø°Ø§ Ø¢Ø®Ø± Ø¯Ø±Ø³")
    
    # Additional resources
    st.subheader("ğŸ“š Ù…ÙˆØ§Ø±Ø¯ Ø¥Ø¶Ø§ÙÙŠØ©")
    st.write("Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ù…Ù…Ø§Ø±Ø³Ø©:")
    st.write("â€¢ Ø¬Ø±Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù…Ø«Ù„Ø©")
    st.write("â€¢ Ø§ÙƒØªØ¨ Ø£ÙƒÙˆØ§Ø¯ Ù…Ø´Ø§Ø¨Ù‡Ø©")
    st.write("â€¢ ØªØ£ÙƒØ¯ Ù…Ù† ÙÙ‡Ù… ÙƒÙ„ Ø³Ø·Ø±")
    st.write("â€¢ Ù„Ø§ ØªØªØ±Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø±Ø³")

# Footer
st.markdown("---")
col_foot1, col_foot2, col_foot3 = st.columns(3)

with col_foot1:
    if st.button("ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"):
        st.switch_page("app.py")

with col_foot2:
    if st.button("ğŸ® Ù…Ù„Ø¹Ø¨ Ø§Ù„ÙƒÙˆØ¯"):
        st.switch_page("pages/2_Ù…Ù„Ø¹Ø¨_Ø§Ù„ÙƒÙˆØ¯.py")

with col_foot3:
    if st.button("ğŸ“Š Ø§Ù„ØªÙ‚Ø¯Ù…"):
        st.switch_page("pages/4_Ø§Ù„ØªÙ‚Ø¯Ù….py")
